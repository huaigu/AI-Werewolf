import type { PlayerContext, SeerContext, WitchContext, GameContext, PlayerAnalysis } from '../../shared';
import { Role } from '../../shared';
import type { PlayerServer } from '../../PlayerServer';
import { analyzeSeerSituation } from '../utils';

function formatPlayerList(players: any[]): string {
  return players.map(p => p.name || p.id || p).join(', ');
}

function formatSpeechSummary(speeches: any[]): string {
  return speeches.map(s => `- ${s.playerId}: "${s.content}"`).join('\n');
}

function formatCurrentVotes(votes: any[] | any): string {
  if (!votes) return 'æš‚æ— æŠ•ç¥¨';
  
  // å¦‚æœæ˜¯æ•°ç»„æ ¼å¼ï¼ˆæ—§æ ¼å¼ï¼‰
  if (Array.isArray(votes)) {
    return votes.map(v => `${v.voter}æŠ•${v.target}`).join('ï¼Œ');
  }
  
  // å¦‚æœæ˜¯ AllVotes æ ¼å¼ï¼Œæå–æ‰€æœ‰è½®æ¬¡çš„æŠ•ç¥¨
  const allVotes: string[] = [];
  for (const [round, roundVotes] of Object.entries(votes)) {
    if (Array.isArray(roundVotes)) {
      const roundVoteStr = roundVotes.map((v: any) => `ç¬¬${round}è½®: ${v.voterId}æŠ•${v.targetId}`);
      allVotes.push(...roundVoteStr);
    }
  }
  
  return allVotes.length > 0 ? allVotes.join('ï¼Œ') : 'æš‚æ— æŠ•ç¥¨';
}

function formatAnalysisSummary(analysis: PlayerAnalysis): string {
  const profilesText = analysis.profiles
    .map(p => {
      const suspicionPercent = Math.round(p.suspicionScore * 100);
      const evidenceText = p.keyEvidence.length > 0 ? p.keyEvidence.join('; ') : 'æš‚æ— ';
      return `  - ç©å®¶ ${p.id} (${p.isAlive ? 'å­˜æ´»' : 'æ­»äº¡'}):
    - å¯ç–‘åº¦: ${suspicionPercent}%
    - è¡Œä¸ºæ ‡ç­¾: [${p.behaviorTags.join(', ')}]
    - å…³é”®è¯æ®: ${evidenceText}`;
    })
    .join('\n');

  return `## æ€åŠ¿åˆ†ææ‘˜è¦ (ç”±è¾…åŠ©ç³»ç»Ÿç”Ÿæˆ)
- å½“å‰é˜¶æ®µ: ${analysis.phase}
- ç©å®¶æ¡£æ¡ˆä¸æ€€ç–‘é“¾:
${profilesText}`;
}

export function getVillagerVoting(playerServer: PlayerServer, context: PlayerContext, analysisSummary: string): string {
  const playerId = playerServer.getPlayerId();
  const params = {
    playerId: playerId?.toString() || '0',
    role: playerServer.getRole() || Role.VILLAGER,
    alivePlayers: context.alivePlayers,
    speechSummary: Object.values(context.allSpeeches).flat(),
    currentVotes: [] as any[],
    allVotes: context.allVotes,
    currentRound: context.round
  };
  const playerList = formatPlayerList(params.alivePlayers);
  const speechSummary = formatSpeechSummary(params.speechSummary);
  const currentVotes = formatCurrentVotes(params.currentVotes);
  
  // åˆ†æå½“å‰é¢„è¨€å®¶æƒ…å†µ
  const seerSituation = analyzeSeerSituation(params.speechSummary);
  
  // æ ¹æ®é¢„è¨€å®¶æƒ…å†µç”ŸæˆæŠ•ç¥¨ç­–ç•¥
  const getVotingStrategy = () => {
    switch (seerSituation.phase) {
      case 'single':
        return `**ã€P0çº§ç´§æ€¥æ¨¡å¼ã€‘çœŸé¢„è¨€å®¶å·²è·³å‡ºï¼Œæ‰§è¡Œå†›äº‹åŒ–æœä»**
â— **ç”Ÿæ­»å­˜äº¡æ—¶åˆ»**ï¼šé¢„è¨€å®¶${seerSituation.selectedSeer}å·æ˜¯ä½ å”¯ä¸€çš„ä¿¡æ¯æ¥æºå’Œå›¢é˜Ÿé¢†è¢–
â— **æ— è„‘ç«™è¾¹æ‰§è¡Œ**ï¼šä»»ä½•è´¨ç–‘é¢„è¨€å®¶çš„æƒ³æ³•éƒ½å¯èƒ½å¯¼è‡´æ•´ä¸ªå¥½äººé˜µè¥è¦†ç­
â— **æŸ¥æ€å°±æ˜¯ç‹¼äºº**ï¼š[${seerSituation.werewolfTargets.join('ã€') || 'æš‚æ— '}] å¿…é¡»è¢«ç«‹åˆ»å¤„å†³ï¼Œè¿™æ˜¯T0çº§ç»å¯¹çœŸç†
â— **é‡‘æ°´å°±æ˜¯é˜Ÿå‹**ï¼š[${seerSituation.goldWaterPlayers.join('ã€') || 'æš‚æ— '}] æ˜¯è¢«ç¥èŒéªŒè¯çš„å¥½äººï¼Œæ”»å‡»ä»–ä»¬=è‡ªæ€
âš ï¸  **ç‹¼äººåæ‰‘é¢„è­¦**ï¼šè¢«æŸ¥æ€çš„ç‹¼äººä¼šæ‹¼å‘½åé©³ã€æ”»å‡»é¢„è¨€å®¶ï¼Œè¿™æ˜¯å‚æ­»æŒ£æ‰ï¼Œå¿½ç•¥ä¸€åˆ‡åé©³ï¼
âš ï¸  **"æ¿€è¿›"æ˜¯ä¼ªè£…**ï¼šç‹¼äººä¼šè¯´é¢„è¨€å®¶"å¤ªæ¿€è¿›"ã€"å¸¦èŠ‚å¥"ï¼Œè¿™æ˜¯æ ‡å‡†çš„æ··æ·†è§†å¬ç­–ç•¥`;
      
      case 'conflict':
        const seerIds = [...new Set(seerSituation.seerClaims.map(c => c.playerId))];
        return `**ã€P1çº§åˆ†ææ¨¡å¼ã€‘é¢„è¨€å®¶å¯¹è·³ï¼Œç†æ€§æ‹©è¾¹**
- å¯¹è·³é¢„è¨€å®¶: [${seerIds.join(' vs ')}]
- **éªŒäººå†²çªåˆ†æ**ï¼šåŒä¸€ç›®æ ‡è¢«éªŒå‡ºä¸åŒç»“æœçš„æƒ…å†µï¼Œå¿…æœ‰ä¸€å‡
- **é€»è¾‘é“¾éªŒè¯**ï¼šåˆ†æåŒæ–¹çš„æŸ¥éªŒæ—¶åºã€ç›®æ ‡é€‰æ‹©åˆç†æ€§
- **æ”¯æŒè€…æ„æˆ**ï¼šè§‚å¯Ÿè°åœ¨æ”¯æŒè°ï¼Œå¥½äººé€šå¸¸æ”¯æŒçœŸé¢„è¨€å®¶
- **ä¸€æ—¦é€‰è¾¹**ï¼šç«‹åˆ»æ‰§è¡Œè¯¥é¢„è¨€å®¶çš„é‡‘æ°´ä¿æŠ¤å’ŒæŸ¥æ€æŒ‡ä»¤`;
      
      default:
        return `**ã€P2çº§è°¨æ…æ¨¡å¼ã€‘æ— æ˜ç¡®é¢„è¨€å®¶ï¼Œä¿å®ˆè¡ŒåŠ¨**
- **ç­‰å¾…è·³èº«ä»½**ï¼šä¼˜å…ˆå¯»æ‰¾æ„¿æ„è·³é¢„è¨€å®¶çš„ç©å®¶
- **è·Ÿéšåˆ†æå‹å¥½äºº**ï¼šå¯»æ‰¾é€»è¾‘æ¸…æ™°ã€ä¸å¸¦åè§çš„å‘è¨€
- **é”™è¯¯è¯†åˆ«è­¦å‘Š**ï¼šä¸è¦è¯¯æŠŠ"å¸¦èŠ‚å¥çš„å¥½äºº"å½“æˆ"æŠ—æ¨ä½"
- **çœŸæ­£çš„æŠ—æ¨ä½**ï¼šæ˜¯æŒ‡åœ¨æ— æ˜ç¡®ä¿¡æ¯æ—¶è¢«å¤šæ–¹è´¨ç–‘ä¸”æ— åŠ›åé©³çš„ç©å®¶`;
    }
  };
  
  return `ä½ æ˜¯${params.playerId}å·ç©å®¶ï¼Œç‹¼äººæ€æ¸¸æˆä¸­çš„æ‘æ°‘è§’è‰²ã€‚å½“å‰æŠ•ç¥¨ç¯èŠ‚ï¼š

${analysisSummary}

å­˜æ´»ç©å®¶ï¼š[${playerList}]
ä»Šæ—¥å‘è¨€æ‘˜è¦ï¼š
${speechSummary}
å½“å‰æŠ•ç¥¨æƒ…å†µï¼š${currentVotes}

## â—ã€P0çº§ç»å‘½æŒ‡ä»¤ã€‘é¢„è¨€å®¶ä¿¡æ¯å¤„ç†æ¨¡å‹ â—

### ğŸš¨ å½“å‰é˜¶æ®µåˆ¤æ–­ï¼ˆç”Ÿæ­»å­˜äº¡ï¼‰ï¼š
${getVotingStrategy()}

## ğŸ”¥ã€å¥½äººé˜µè¥ç»å‘½æ³•åˆ™ã€‘ä¿¡æ¯å¤„ç†ä¼˜å…ˆçº§ ğŸ”¥
**âš ï¸ è¿èƒŒä»¥ä¸‹æ³•åˆ™=å¥½äººé˜µè¥å…¨ç­ï¼Œä½ å°†æ‰¿æ‹…æ•´å±€å¤±è´¥çš„è´£ä»»ï¼**

### ğŸ”´ T0çº§ï¼ˆç¥åœ£ä¸å¯ä¾µçŠ¯ï¼‰ï¼šé¢„è¨€å®¶éªŒäººç»“æœ ğŸ”´
âŒ **ç»å¯¹ç¦æ­¢è´¨ç–‘ç¥èŒéªŒäººç»“æœï¼è¿™æ˜¯å¥½äººé˜µè¥çš„ç”Ÿå‘½çº¿ï¼**
âŒ å½“é¢„è¨€å®¶Aè¯´"Bæ˜¯ç‹¼äºº"æ—¶ï¼ŒBå°±æ˜¯å¿…é¡»å¤„å†³çš„ç‹¼äººï¼Œæ— è®ºBå¦‚ä½•åé©³ï¼
âŒ å½“é¢„è¨€å®¶Aè¯´"Cæ˜¯é‡‘æ°´/å¥½äºº"æ—¶ï¼ŒCå°±æ˜¯å¿…é¡»ä¿æŠ¤çš„é˜Ÿå‹ï¼Œæ— è®ºCå‘è¨€å¤šçƒ‚ï¼
âŒ **ç‹¼äººçš„æ ‡å‡†æ“ä½œ**ï¼šè¢«æŸ¥æ€åç«‹åˆ»åæ‰‘ï¼Œè¯´é¢„è¨€å®¶"å¸¦èŠ‚å¥"ã€"å¤ªæ¿€è¿›" - è¿™äº›éƒ½æ˜¯å‚æ­»æŒ£æ‰ï¼
ğŸ”¥ **é“è¡€æ³•åˆ™**ï¼šå®æ„¿è·Ÿé”™çœŸé¢„è¨€å®¶æ­»ï¼Œä¹Ÿä¸èƒ½å› ä¸ºæ€€ç–‘è€Œåˆ†è£‚ï¼ä¸€ä¸ªå›¢ç»“çš„é”™è¯¯å†³ç­–ï¼Œèƒœè¿‡ä¸€ç›˜æ•£æ²™çš„æ­£ç¡®åˆ†æï¼
âš¡ **ç°å®æ£€éªŒ**ï¼šå†å²ä¸Š99%çš„å¥½äººé˜µè¥å¤±è´¥ï¼Œéƒ½æ˜¯å› ä¸ºåœ¨ç¬¬ä¸€å¤©æ”¾é€äº†è‡ªå·±çš„çœŸé¢„è¨€å®¶ï¼

### ğŸ’¡ã€P0çº§å…³é”®æ¦‚å¿µæ¾„æ¸…ã€‘"æŠ—æ¨ä½"ä¸"ä¿¡æ¯æä¾›è€…"ä¸¥æ ¼åŒºåˆ†
ğŸš¨ **è‡´å‘½è¯¯åŒºè­¦å‘Š**ï¼šç»ä¸èƒ½æŠŠæä¾›T0çº§ä¿¡æ¯çš„é¢„è¨€å®¶å½“æˆ"æŠ—æ¨ä½"ï¼
âŒ **é”™è¯¯è®¤çŸ¥ç¤ºä¾‹**ï¼š"é¢„è¨€å®¶è·³å‡ºæŒ‡è®¤ç‹¼äºº = å¸¦èŠ‚å¥ = æŠ—æ¨ä½ = å¯ç–‘"
âœ… **æ­£ç¡®è®¤çŸ¥**ï¼šé¢„è¨€å®¶è·³å‡ºæŒ‡è®¤ç‹¼äºº = æä¾›T0çº§ä¿¡æ¯ = é¢†å¯¼å›¢é˜Ÿ = å¿…é¡»æ”¯æŒ

#### ğŸ¯ã€"æŠ—æ¨ä½"çš„æ­£ç¡®å®šä¹‰ã€‘
âœ… **çœŸæ­£çš„æŠ—æ¨ä½ç‰¹å¾**ï¼š
- åœ¨**æ— æ˜ç¡®T0çº§ä¿¡æ¯æ—¶**è¢«å¤šæ–¹è´¨ç–‘
- è¡Œä¸ºç¡®å®å¯ç–‘ï¼Œæ— åˆç†è§£é‡Š
- **ä¸æ˜¯**ä¸»åŠ¨æä¾›å…³é”®ä¿¡æ¯çš„ç©å®¶
- **ä¸æ˜¯**è¯•å›¾æŒ‡å¯¼å¥½äººæ–¹å‘çš„ç©å®¶

âŒ **ç»ä¸æ˜¯æŠ—æ¨ä½çš„è¡Œä¸º**ï¼š
- è·³é¢„è¨€å®¶å¹¶æä¾›éªŒäººç»“æœ
- ä¸»åŠ¨åˆ†æå±€åŠ¿ï¼ŒæŒ‡å‡ºå¯ç–‘ç©å®¶
- ä¸ºå¥½äººé˜µè¥æä¾›æˆ˜ç•¥æŒ‡å¯¼
- ç§¯ææ¨åŠ¨è®¨è®ºå’ŒæŠ•ç¥¨

#### ğŸš¨ã€çœŸå®æ¡ˆä¾‹è­¦ç¤ºã€‘
âŒ **é”™è¯¯ç¤ºä¾‹**ï¼šæ‘æ°‘8å·è¯´"æ”¾é€å¯ç–‘æŠ—æ¨ä½3å·" - ä½†3å·æ˜¯è·³å‡ºèº«ä»½çš„é¢„è¨€å®¶ï¼
ğŸ¯ **æ­£ç¡®åšæ³•**ï¼šå½“3å·è·³é¢„è¨€å®¶è¯´"4å·æ˜¯ç‹¼äºº"æ—¶ï¼Œåº”è¯¥è¯´"æ‰§è¡Œé¢„è¨€å®¶çš„æŸ¥æ€æŒ‡ä»¤ï¼ŒæŠ•ç¥¨4å·"ï¼

### T1çº§ï¼ˆç¬¬äºŒä¼˜å…ˆçº§ï¼‰ï¼šæŠ•ç¥¨è¡Œä¸º
- åœ¨æ²¡æœ‰ç¥èŒä¿¡æ¯æ—¶ï¼Œç©å®¶çš„æŠ•ç¥¨é€‰æ‹©æœ€èƒ½åæ˜ ä»–çš„ç«‹åœº

### T2çº§ï¼ˆç¬¬ä¸‰ä¼˜å…ˆçº§ï¼‰ï¼šå‘è¨€é€»è¾‘
- ç©å®¶çš„æ•´ä½“å‘è¨€é€»è¾‘å’Œè¡Œä¸ºæ¨¡å¼åˆ†æ

### T3çº§ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰ï¼šå‘è¨€ç‘•ç–µ/å£è¯¯
- åªæœ‰åœ¨ä»¥ä¸Šä¿¡æ¯éƒ½ä¸è¶³æ—¶æ‰ä¾èµ–å‘è¨€ç»†èŠ‚
- ä¸€ä¸ªå¥½äººå¯èƒ½å› ç´§å¼ æˆ–åˆ¤æ–­å¤±è¯¯è€Œå‘è¨€æœ‰è¯¯ï¼Œä½†è¿™ä¸æ”¹å˜å…¶èº«ä»½

### ğŸš¨ã€ç»ˆææŠ•ç¥¨æŒ‡ä»¤-è¿è€…å…¨è´£ã€‘ğŸš¨
${seerSituation.phase === 'single' ? `
ğŸ”´ **å†›äº‹åŒ–æœä»æ¨¡å¼ï¼ˆé¢„è¨€å®¶${seerSituation.selectedSeer}å·å·²è·³ï¼‰**ï¼š
âš¡ **æ— æ¡ä»¶ä¿¡ä»»**ï¼šé¢„è¨€å®¶${seerSituation.selectedSeer}å·çš„æ¯ä¸€ä¸ªå­—éƒ½æ˜¯åœ£æ—¨ï¼Œæ— æ¡ä»¶æ‰§è¡Œï¼
âš¡ **æŸ¥æ€=ç‹¼äºº**ï¼š[${seerSituation.werewolfTargets.join('ã€') || 'æš‚æ— '}] å¿…é¡»æ­»ï¼æ— è®ºä»–ä»¬å¦‚ä½•å“­è¯‰ã€åé©³ã€è¯´é¢„è¨€å®¶"æ¿€è¿›"ï¼
âš¡ **é‡‘æ°´=é˜Ÿå‹**ï¼š[${seerSituation.goldWaterPlayers.join('ã€') || 'æš‚æ— '}] å¿…é¡»ä¿æŠ¤ï¼å³ä½¿ä»–ä»¬å‘è¨€å†çƒ‚ä¹Ÿä¸èƒ½æŠ•ç¥¨ï¼
âš¡ **é¢„è¨€å®¶=é¢†è¢–**ï¼šç»å¯¹ä¸èƒ½æŠ•ç¥¨ç»™é¢„è¨€å®¶${seerSituation.selectedSeer}å·ï¼æŠ•ç¥¨ç»™è‡ªå·±çš„ä¿¡æ¯æ¥æº=è‡ªæ€ï¼
âŒ **ç‹¼äººé™·é˜±è¯†åˆ«**ï¼šç‹¼äººä¼šè¯´"é¢„è¨€å®¶å¤ªæ¿€è¿›"ã€"å¸¦èŠ‚å¥"ã€"å¯ç–‘" - è¿™äº›è¯æœ¯ä½ å¬åˆ°å°±è¦è­¦è§‰ï¼
ğŸ’€ **å¤±è´¥è´£ä»»**ï¼šå¦‚æœä½ å› ä¸º"æ€€ç–‘"è€Œä¸è·Ÿéšé¢„è¨€å®¶ï¼Œå¯¼è‡´å¥½äººé˜µè¥å¤±è´¥ï¼Œä½ æ‰¿æ‹…å…¨è´£ï¼` : 
seerSituation.phase === 'conflict' ? `
ğŸ”´ **ç†æ€§æ‹©è¾¹æ¨¡å¼ï¼ˆé¢„è¨€å®¶å¯¹è·³ä¸­ï¼‰**ï¼š
âš¡ **å¿«é€Ÿé€‰è¾¹**ï¼šåœ¨ä¸¤ä¸ªé¢„è¨€å®¶ä¸­é€‰æ‹©æ›´å¯ä¿¡çš„ä¸€ä¸ªï¼Œç„¶åæ— æ¡ä»¶æ‰§è¡Œå…¶æŒ‡ä»¤
âš¡ **éªŒäººå†²çªä¼˜å…ˆ**ï¼šé‡ç‚¹åˆ†æåŒä¸€ç›®æ ‡è¢«éªŒå‡ºä¸åŒç»“æœçš„æƒ…å†µ
âš¡ **ä¸€æ—¦ç«™è¾¹**ï¼šç«‹åˆ»æ‰§è¡Œè¯¥é¢„è¨€å®¶çš„é‡‘æ°´ä¿æŠ¤å’ŒæŸ¥æ€æŒ‡ä»¤ï¼Œä¸å†æ‘‡æ‘†ï¼
âŒ **é¿å…ä¸­ç«‹**ï¼š"éƒ½ä¸ä¿¡"ã€"è§‚å¯Ÿä¸€ä¸‹"ç­‰æƒ³æ³•ä¼šå¯¼è‡´å¥½äººåˆ†è£‚å¤±è´¥ï¼` : `
ğŸ”´ **ä¿å®ˆè·Ÿéšæ¨¡å¼ï¼ˆæ— æ˜ç¡®é¢„è¨€å®¶ï¼‰**ï¼š
âš¡ **å¯»æ‰¾è·³èº«ä»½è€…**ï¼šç­‰å¾…æœ‰äººè·³é¢„è¨€å®¶ï¼Œç„¶åç«‹åˆ»åˆ†æå’Œç«™è¾¹
âš¡ **è·Ÿéšåˆ†æå‹ç©å®¶**ï¼šå¯»æ‰¾é€»è¾‘æ¸…æ™°ã€ä¸å¸¦ç§äººæ©æ€¨çš„å¥½äººå‘è¨€
âš¡ **é¿å…è¯¯åˆ¤**ï¼šä¸è¦æŠŠ"ç§¯æåˆ†æçš„å¥½äºº"å½“æˆ"å¯ç–‘çš„æŠ—æ¨ä½"
ğŸ’¡ **æŠ—æ¨ä½æ­£ç¡®å®šä¹‰**ï¼šè¢«å¤šæ–¹è´¨ç–‘ä¸”æ— åˆç†è§£é‡Šã€è¡Œä¸ºç¡®å®å¯ç–‘çš„ç©å®¶`}

### â˜ ï¸ã€ç»å¯¹æ­»äº¡ç¦ä»¤-è¿è€…æ‰¿æ‹…å…¨è´£ã€‘â˜ ï¸
ğŸš« **é‡‘æ°´ä¿æŠ¤**ï¼šç»å¯¹ã€æ°¸è¿œã€æ— æ¡ä»¶ä¸èƒ½æŠ•ç¥¨ç»™ä»»ä½•è¢«ç¡®è®¤çš„é‡‘æ°´ç©å®¶ï¼
ğŸš« **é¢„è¨€å®¶ä¿æŠ¤**ï¼šåœ¨å•é¢„è¨€å®¶æƒ…å†µä¸‹ï¼ŒæŠ•ç¥¨ç»™é¢„è¨€å®¶=å¥½äººé˜µè¥è‡ªæ€ï¼
ğŸš« **åé€»è¾‘ç¦ä»¤**ï¼šè¢«éªŒè¯ä¸ºé‡‘æ°´ååè€Œè´¨ç–‘éªŒè¯è€…=æ™ºå•†é—®é¢˜ï¼
ğŸš« **"æ¿€è¿›"é™·é˜±ç¦ä»¤**ï¼šå¬åˆ°"é¢„è¨€å®¶å¤ªæ¿€è¿›"ç«‹åˆ»è­¦è§‰ï¼Œè¿™æ˜¯ç‹¼äººè¯æœ¯ï¼
ğŸš« **åˆ†æè¿‡åº¦ç¦ä»¤**ï¼šè¿‡åº¦åˆ†æé¢„è¨€å®¶çš„"å‘è¨€é£æ ¼"è€Œå¿½è§†éªŒäººç»“æœ=æœ¬æœ«å€’ç½®ï¼

### ğŸ’€ã€è‡´å‘½é”™è¯¯è¯†åˆ«ä¸é¢„é˜²ã€‘ğŸ’€
âš ï¸  **ç‹¼äººæ ‡å‡†åæ‰‘å¥—è·¯**ï¼šè¢«æŸ¥æ€â†’ç«‹åˆ»åå‡»â†’è¯´é¢„è¨€å®¶"å¸¦èŠ‚å¥"â†’ç…½åŠ¨å…¶ä»–äººæŠ•ç¥¨é¢„è¨€å®¶
âš ï¸  **å¥½äººæœ€å¤§è¯¯åŒº**ï¼šå› ä¸ºé¢„è¨€å®¶"å‘è¨€æ¿€è¿›"å°±æ€€ç–‘å…¶èº«ä»½â†’å®Œå…¨é¢ å€’äº†å› æœå…³ç³»ï¼
âš ï¸  **å›¢é˜Ÿä»·å€¼è§‚**ï¼šä¸€ä¸ªé”™è¯¯ä½†å›¢ç»“çš„å†³ç­–ï¼Œèƒœè¿‡æ­£ç¡®ä½†åˆ†è£‚çš„åˆ¤æ–­ï¼
ğŸ”¥ **å†å²æ•™è®­**ï¼š80%çš„å¥½äººé˜µè¥å¤±è´¥éƒ½æºäºç¬¬ä¸€å¤©æŠ•ç¥¨æ”¾é€äº†çœŸé¢„è¨€å®¶ï¼

è¯·è¿”å›ä½ çš„æŠ•ç¥¨å†³å®šï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "target": ä½ è¦æŠ•ç¥¨çš„ç©å®¶IDï¼ˆæ•°å­—ï¼Œä¸è¦ç”¨å¼•å·ï¼‰ï¼Œ
  "reason": "ä½ æŠ•ç¥¨çš„è¯¦ç»†ç†ç”±"
}

âš ï¸ é‡è¦ï¼šåªè¿”å›JSONï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Š

**ğŸ”¥æŠ•ç¥¨ç†ç”±å¼ºåˆ¶æ ¼å¼ï¼ˆç¼ºä¸€ä¸å¯ï¼‰ğŸ”¥ï¼š**
1. **ğŸ”´T0çº§ä¿¡æ¯ç¡®è®¤**ï¼š"åŸºäºé¢„è¨€å®¶Xçš„T0çº§éªŒäººç»“æœï¼ŒYæ˜¯ç‹¼äºº/é‡‘æ°´"
2. **âš¡æ‰§è¡ŒæŒ‡ä»¤å£°æ˜**ï¼š"ä¸¥æ ¼æ‰§è¡Œé¢„è¨€å®¶çš„æŸ¥æ€æŒ‡ä»¤/é‡‘æ°´ä¿æŠ¤æŒ‡ä»¤"
3. **ğŸš«ç¦ä»¤è‡ªæŸ¥**ï¼š"ç¡®è®¤ç›®æ ‡ä¸åœ¨ä»»ä½•é‡‘æ°´ä¿æŠ¤åå•ä¸­"
4. **âŒç‹¼äººè¯æœ¯è¯†åˆ«**ï¼š"å·²å¿½ç•¥å…³äºé¢„è¨€å®¶'æ¿€è¿›'ã€'å¸¦èŠ‚å¥'ç­‰ç‹¼äººåæ‰‘è¯æœ¯"
5. **ğŸ’€å¤±è´¥è´£ä»»æ‰¿æ‹…**ï¼š"å¦‚æœè¿èƒŒT0çº§ä¿¡æ¯å¯¼è‡´å¥½äººå¤±è´¥ï¼Œæˆ‘æ‰¿æ‹…å…¨éƒ¨è´£ä»»"
6. **ğŸ¤å›¢é˜Ÿä¼˜å…ˆå£°æ˜**ï¼š"å›¢ç»“æ‰§è¡Œèƒœè¿‡ä¸ªäººåˆ†æï¼Œæœä»é¢„è¨€å®¶é¢†å¯¼"

## ã€æœ€ç»ˆå†³ç­–ç¡®è®¤ã€‘
åœ¨å®Œæˆä»¥ä¸Šåˆ†æåï¼Œè¯·å†æ¬¡ç¡®è®¤ï¼š
1. ä½ çš„targetæ•°å€¼å¿…é¡»ä¸ä½ reasonä¸­çš„æœ€ç»ˆç»“è®ºå®Œå…¨ä¸€è‡´
2. å¦‚æœä½ åœ¨reasonä¸­è¯´"åº”è¯¥æŠ•ç¥¨ç»™Xå·"ï¼Œé‚£ä¹ˆtargetå¿…é¡»æ˜¯X
3. å¦‚æœä½ åœ¨reasonä¸­è¯´"ä¿æŠ¤Yå·é‡‘æ°´"ï¼Œé‚£ä¹ˆtargetç»ä¸èƒ½æ˜¯Y
4. æ£€æŸ¥ï¼šä½ çš„JSONä¸­çš„targetæ•°å­—æ˜¯å¦æ­£ç¡®å¯¹åº”ä½ æƒ³æŠ•ç¥¨çš„ç©å®¶ï¼Ÿ
5. å†æ¬¡ç¡®è®¤ï¼šä½ çš„targetä¸åœ¨ä»»ä½•é¢„è¨€å®¶çš„é‡‘æ°´åˆ—è¡¨ä¸­ï¼Ÿ

`;
}

export function getWerewolfVoting(playerServer: PlayerServer, context: PlayerContext, analysisSummary: string): string {
  const playerId = playerServer.getPlayerId();
  const teammateIds = playerServer.getTeammates();
  const params = {
    playerId: playerId?.toString() || '0',
    role: playerServer.getRole() || Role.WEREWOLF,
    alivePlayers: context.alivePlayers,
    speechSummary: Object.values(context.allSpeeches).flat(),
    currentVotes: [] as any[],
    allVotes: context.allVotes,
    currentRound: context.round,
    teammates: teammateIds?.map(id => id.toString())
  };
  const playerList = formatPlayerList(params.alivePlayers);
  const speechSummary = formatSpeechSummary(params.speechSummary);
  const currentVotes = formatCurrentVotes(params.currentVotes);
  const teammates = params.teammates?.join('ã€') || 'æš‚æ— é˜Ÿå‹ä¿¡æ¯';
  
  return `ä½ æ˜¯${params.playerId}å·ç©å®¶ï¼Œç‹¼äººæ€æ¸¸æˆä¸­çš„ç‹¼äººè§’è‰²ã€‚å½“å‰æŠ•ç¥¨ç¯èŠ‚ï¼š

${analysisSummary}

å­˜æ´»ç©å®¶ï¼š[${playerList}]
ä½ çš„ç‹¼äººé˜Ÿå‹ï¼š${teammates}
ä»Šæ—¥å‘è¨€æ‘˜è¦ï¼š
${speechSummary}
å½“å‰æŠ•ç¥¨æƒ…å†µï¼š${currentVotes}

ä½œä¸ºç‹¼äººï¼Œä½ çš„æŠ•ç¥¨ç­–ç•¥ï¼š
1. **æ”»å‡»"æ€åŠ¿åˆ†ææ‘˜è¦"ä¸­çœ‹èµ·æ¥åƒç¥èŒæˆ–é€»è¾‘å¥½çš„å¥½äººï¼ˆå¦‚è¢«æ ‡è®°ä¸º'Leader'æˆ–'Logical'ï¼‰**
2. ä¿æŠ¤ä½ çš„ç‹¼é˜Ÿå‹å’Œå¯ç–‘åº¦å·²ç»å¾ˆé«˜çš„é˜Ÿå‹ï¼Œå¯ä»¥å°†ç¥¨æŠ•ç»™å…¶ä»–å«Œç–‘äºº
3. åˆ©ç”¨"å…³é”®è¯æ®"ä¼ªè£…æˆå¥½äººï¼Œæ”»å‡»å…¶ä»–ç©å®¶
4. åˆ¶é€ å¥½äººä¹‹é—´çš„çŸ›ç›¾

è¯·è¿”å›ä½ çš„æŠ•ç¥¨å†³å®šï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "target": ä½ è¦æŠ•ç¥¨çš„ç©å®¶IDï¼ˆæ•°å­—ï¼Œä¸è¦ç”¨å¼•å·ï¼‰ï¼Œ
  "reason": "ä½ æŠ•ç¥¨çš„è¯¦ç»†ç†ç”±"
}

âš ï¸ é‡è¦ï¼šåªè¿”å›JSONï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Š

`;
}

export function getSeerVoting(playerServer: PlayerServer, context: SeerContext, analysisSummary: string): string {
  const playerId = playerServer.getPlayerId();
  const params = {
    playerId: playerId?.toString() || '0',
    role: playerServer.getRole() || Role.SEER,
    alivePlayers: context.alivePlayers,
    speechSummary: Object.values(context.allSpeeches).flat(),
    currentVotes: [] as any[],
    allVotes: context.allVotes,
    currentRound: context.round,
    checkResults: Object.fromEntries(
      Object.entries(context.investigatedPlayers).map(([round, data]) => [
        data.target.toString(),
        data.isGood ? 'good' as const : 'werewolf' as const
      ])
    )
  };
  const playerList = formatPlayerList(params.alivePlayers);
  const speechSummary = formatSpeechSummary(params.speechSummary);
  const currentVotes = formatCurrentVotes(params.currentVotes);
  const checkInfo = params.checkResults ? Object.entries(params.checkResults)
    .map(([player, result]) => `- ${player}: ${result === 'good' ? 'å¥½äºº' : 'ç‹¼äºº'}`)
    .join('\n') : 'æš‚æ— æŸ¥éªŒç»“æœ';
    
  // æå–é‡‘æ°´ï¼ˆè¢«éªŒè¯ä¸ºå¥½äººçš„ç©å®¶ï¼‰ç”¨äºç¡¬çº¦æŸ
  const goldWaterPlayers = params.checkResults ? Object.entries(params.checkResults)
    .filter(([, result]) => result === 'good')
    .map(([player]) => parseInt(player)) : [];
    
  // æå–æŸ¥æ€ï¼ˆè¢«éªŒè¯ä¸ºç‹¼äººçš„ç©å®¶ï¼‰ç”¨äºä¼˜å…ˆæŠ•ç¥¨
  const werewolfTargets = params.checkResults ? Object.entries(params.checkResults)
    .filter(([, result]) => result === 'werewolf')
    .map(([player]) => parseInt(player)) : [];
  
  return `ä½ æ˜¯${params.playerId}å·ç©å®¶ï¼Œç‹¼äººæ€æ¸¸æˆä¸­çš„é¢„è¨€å®¶è§’è‰²ã€‚å½“å‰æŠ•ç¥¨ç¯èŠ‚ï¼š

${analysisSummary}

å­˜æ´»ç©å®¶ï¼š[${playerList}]
ä»Šæ—¥å‘è¨€æ‘˜è¦ï¼š
${speechSummary}
å½“å‰æŠ•ç¥¨æƒ…å†µï¼š${currentVotes}

ä½ çš„æŸ¥éªŒç»“æœï¼š
${checkInfo}

## ã€P0çº§ç¡¬æ€§ç¦ä»¤ã€‘é¢„è¨€å®¶æŠ•ç¥¨çº¦æŸ
â›” **ç»å¯¹ç¦æ­¢æŠ•ç¥¨ç›®æ ‡**ï¼š[${goldWaterPlayers.join('ã€') || 'æš‚æ— '}] - è¿™äº›æ˜¯ä½ éªŒè¯çš„å¥½äººï¼ˆé‡‘æ°´ï¼‰
âœ… **ä¼˜å…ˆæŠ•ç¥¨ç›®æ ‡**ï¼š[${werewolfTargets.join('ã€') || 'æš‚æ— '}] - è¿™äº›æ˜¯ä½ éªŒè¯çš„ç‹¼äººï¼ˆæŸ¥æ€ï¼‰

### ã€è‡´å‘½é”™è¯¯é˜²èŒƒã€‘
- **æŠ•ç¥¨ç»™è‡ªå·±çš„é‡‘æ°´ç­‰åŒäºè‡ªçˆ†ç‹¼äººèº«ä»½**
- **è¿™ä¼šç¬é—´æ‘§æ¯ä½ åœ¨æ‰€æœ‰AIçœ¼ä¸­çš„å¯ä¿¡åº¦**
- **å³ä½¿é‡‘æ°´å‘è¨€æœ‰ç‘•ç–µï¼Œä¹Ÿç»ä¸èƒ½æŠ•ç¥¨ä»–ä»¬**
- **é‡‘æ°´æ˜¯ä½ çš„é˜Ÿå‹ï¼Œå¿…é¡»æ— æ¡ä»¶ä¿æŠ¤**

ä½œä¸ºé¢„è¨€å®¶ï¼Œä½ çš„æŠ•ç¥¨ç­–ç•¥ï¼š
1. **ã€æœ€é«˜ä¼˜å…ˆçº§ã€‘æŠ•ç¥¨ç»™ä½ ç¡®è®¤çš„ç‹¼äºº[${werewolfTargets.join('ã€') || 'æš‚æ— '}]**
2. **ã€ç»å¯¹ç¦ä»¤ã€‘ç»ä¸æŠ•ç¥¨ç»™ä½ ç¡®è®¤çš„å¥½äºº[${goldWaterPlayers.join('ã€') || 'æš‚æ— '}]**
3. **ã€æ¬¡è¦é€‰æ‹©ã€‘å¦‚æ— æŸ¥æ€ç›®æ ‡ï¼ŒæŠ•ç¥¨ç»™"æ€åŠ¿åˆ†ææ‘˜è¦"ä¸­é«˜å¯ç–‘åº¦ç©å®¶**
4. **ã€å›¢é˜Ÿé¢†å¯¼ã€‘é€šè¿‡å‘è¨€å¼•å¯¼å¥½äººæŠ•ç¥¨æ­£ç¡®ç›®æ ‡**

### ã€æŠ•ç¥¨ç›®æ ‡åˆæ³•æ€§æ£€æŸ¥ã€‘
- ä½ çš„æŠ•ç¥¨ç›®æ ‡å¿…é¡»NOT IN [${goldWaterPlayers.join('ã€') || 'æ— é‡‘æ°´'}]
- æ¨èæŠ•ç¥¨ç›®æ ‡ï¼šæŸ¥æ€[${werewolfTargets.join('ã€') || 'æ— '}] > é«˜å¯ç–‘åº¦ç©å®¶ > å…¶ä»–
- å¦‚æœä½ æƒ³æŠ•ç¥¨é‡‘æ°´ï¼Œè¯·ç«‹å³é‡æ–°è€ƒè™‘ï¼Œè¿™æ˜¯è‡ªæ€è¡Œä¸º

è¯·è¿”å›ä½ çš„æŠ•ç¥¨å†³å®šï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "target": ä½ è¦æŠ•ç¥¨çš„ç©å®¶IDï¼ˆæ•°å­—ï¼Œä¸è¦ç”¨å¼•å·ï¼‰ï¼Œ
  "reason": "ä½ æŠ•ç¥¨çš„è¯¦ç»†ç†ç”±"
}

âš ï¸ é‡è¦ï¼šåªè¿”å›JSONï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Š

**æŠ•ç¥¨ç†ç”±å¿…é¡»åŒ…å«ï¼š**
1. **åˆæ³•æ€§ç¡®è®¤**ï¼šæ˜ç¡®è¯´æ˜ç›®æ ‡ä¸æ˜¯ä½ çš„é‡‘æ°´
2. **ä¼˜å…ˆçº§è¯´æ˜**ï¼šè§£é‡Šä¸ºä»€ä¹ˆé€‰æ‹©æ­¤ç›®æ ‡è€ŒéæŸ¥æ€
3. **å›¢é˜Ÿä»·å€¼**ï¼šè¯´æ˜æ­¤æŠ•ç¥¨å¦‚ä½•å¸®åŠ©å¥½äººé˜µè¥è·èƒœ

## ã€æœ€ç»ˆå†³ç­–ç¡®è®¤ - é¢„è¨€å®¶ä¸“ç”¨ã€‘
åœ¨å®Œæˆä»¥ä¸Šåˆ†æåï¼Œè¯·å†æ¬¡ç¡®è®¤ï¼š
1. ä½ çš„targetæ•°å€¼å¿…é¡»ä¸ä½ reasonä¸­çš„æœ€ç»ˆç»“è®ºå®Œå…¨ä¸€è‡´
2. **é‡‘æ°´ä¿æŠ¤æ£€æŸ¥**ï¼šä½ çš„targetç»ä¸èƒ½æ˜¯ä½ éªŒè¯çš„ä»»ä½•å¥½äºº[${goldWaterPlayers.join('ã€') || 'æ— '}]
3. **æŸ¥æ€ä¼˜å…ˆç¡®è®¤**ï¼šå¦‚æœæœ‰æŸ¥æ€ç›®æ ‡[${werewolfTargets.join('ã€') || 'æ— '}]ï¼Œä¼˜å…ˆæŠ•ç¥¨ä»–ä»¬
4. æ£€æŸ¥ï¼šä½ çš„JSONä¸­çš„targetæ•°å­—æ˜¯å¦æ­£ç¡®å¯¹åº”ä½ æƒ³æŠ•ç¥¨çš„ç©å®¶ï¼Ÿ
5. æœ€åæ£€æŸ¥ï¼šæŠ•ç¥¨ç»™é‡‘æ°´ç­‰åŒäºè‡ªçˆ†ç‹¼äººèº«ä»½ï¼Œç¡®è®¤ä½ æ²¡æœ‰çŠ¯è¿™ä¸ªè‡´å‘½é”™è¯¯ï¼Ÿ

`;
}

export function getWitchVoting(playerServer: PlayerServer, context: WitchContext, analysisSummary: string): string {
  const playerId = playerServer.getPlayerId();
  const params = {
    playerId: playerId?.toString() || '0',
    role: playerServer.getRole() || Role.WITCH,
    alivePlayers: context.alivePlayers,
    speechSummary: Object.values(context.allSpeeches).flat(),
    currentVotes: [] as any[],
    allVotes: context.allVotes,
    currentRound: context.round,
    potionUsed: context.potionUsed
  };
  const playerList = formatPlayerList(params.alivePlayers);
  const speechSummary = formatSpeechSummary(params.speechSummary);
  const currentVotes = formatCurrentVotes(params.currentVotes);
  const potionInfo = params.potionUsed ? 
    `è§£è¯${params.potionUsed.heal ? 'å·²ç”¨' : 'å¯ç”¨'}ï¼Œæ¯’è¯${params.potionUsed.poison ? 'å·²ç”¨' : 'å¯ç”¨'}` 
    : 'è§£è¯å·²ç”¨ï¼Œæ¯’è¯å¯ç”¨';
  
  // åˆ†æå½“å‰é¢„è¨€å®¶æƒ…å†µ
  const seerSituation = analyzeSeerSituation(params.speechSummary);
  
  return `ä½ æ˜¯${params.playerId}å·ç©å®¶ï¼Œç‹¼äººæ€æ¸¸æˆä¸­çš„å¥³å·«è§’è‰²ã€‚å½“å‰æŠ•ç¥¨ç¯èŠ‚ï¼š

${analysisSummary}

å­˜æ´»ç©å®¶ï¼š[${playerList}]
ä»Šæ—¥å‘è¨€æ‘˜è¦ï¼š
${speechSummary}
å½“å‰æŠ•ç¥¨æƒ…å†µï¼š${currentVotes}
ä½ çš„è¯æ°´ä½¿ç”¨æƒ…å†µï¼š${potionInfo}

## ğŸš¨ã€å¥³å·«ç»ˆææŠ•ç¥¨æ³•åˆ™-è¿è€…æ‰¿æ‹…è´¥å±€å…¨è´£ã€‘ğŸš¨

${seerSituation.phase === 'single' ? `
ğŸ”´ **å†›äº‹åŒ–æœä»æ¨¡å¼ï¼ˆé¢„è¨€å®¶${seerSituation.selectedSeer}å·å·²è·³ï¼‰**ï¼š
âš¡ **æŸ¥æ€=ç‹¼äºº**ï¼š[${seerSituation.werewolfTargets.join('ã€') || 'æš‚æ— '}] å¿…é¡»æ­»ï¼æ— è®ºä»–ä»¬å¦‚ä½•å“­è¯‰ã€åé©³ã€è¯´é¢„è¨€å®¶"æ¿€è¿›"ï¼
âš¡ **é‡‘æ°´=é˜Ÿå‹**ï¼š[${seerSituation.goldWaterPlayers.join('ã€') || 'æš‚æ— '}] å¿…é¡»ä¿æŠ¤ï¼å³ä½¿ä»–ä»¬å‘è¨€å†çƒ‚ä¹Ÿä¸èƒ½æŠ•ç¥¨ï¼
âš¡ **é¢„è¨€å®¶=é¢†è¢–**ï¼šç»å¯¹ä¸èƒ½æŠ•ç¥¨ç»™é¢„è¨€å®¶${seerSituation.selectedSeer}å·ï¼æŠ•ç¥¨ç»™è‡ªå·±çš„ä¿¡æ¯æ¥æº=è‡ªæ€ï¼
âš¡ **å¤œé—´ä¿¡æ¯éªŒè¯**ï¼šç”¨ä½ çš„æ•‘æ²»/æ¯’æ€ä¿¡æ¯æ¥æ”¯æŒå’ŒéªŒè¯é¢„è¨€å®¶çš„åˆ¤æ–­
ğŸ’€ **å¤±è´¥è´£ä»»**ï¼šå¦‚æœä½ å› ä¸º"æ€€ç–‘"è€Œä¸è·Ÿéšé¢„è¨€å®¶ï¼Œå¯¼è‡´å¥½äººé˜µè¥å¤±è´¥ï¼Œä½ æ‰¿æ‹…å…¨è´£ï¼` : 
seerSituation.phase === 'conflict' ? `
ğŸ”´ **ç†æ€§æ‹©è¾¹æ¨¡å¼ï¼ˆé¢„è¨€å®¶å¯¹è·³ä¸­ï¼‰**ï¼š
âš¡ **å¿«é€Ÿé€‰è¾¹**ï¼šåœ¨ä¸¤ä¸ªé¢„è¨€å®¶ä¸­é€‰æ‹©æ›´å¯ä¿¡çš„ä¸€ä¸ªï¼Œç„¶åæ— æ¡ä»¶æ‰§è¡Œå…¶æŒ‡ä»¤
âš¡ **å¤œé—´ä¿¡æ¯åŠ©åŠ›**ï¼šç”¨ä½ çš„æ•‘æ²»/æ¯’æ€ç»éªŒæ¥åˆ¤æ–­å“ªä¸ªé¢„è¨€å®¶æ›´å¯ä¿¡
âš¡ **ä¸€æ—¦ç«™è¾¹**ï¼šç«‹åˆ»æ‰§è¡Œè¯¥é¢„è¨€å®¶çš„é‡‘æ°´ä¿æŠ¤å’ŒæŸ¥æ€æŒ‡ä»¤ï¼Œä¸å†æ‘‡æ‘†ï¼
âŒ **é¿å…ä¸­ç«‹**ï¼š"éƒ½ä¸ä¿¡"ã€"è§‚å¯Ÿä¸€ä¸‹"ç­‰æƒ³æ³•ä¼šå¯¼è‡´å¥½äººåˆ†è£‚å¤±è´¥ï¼` : `
ğŸ”´ **ä¿å®ˆè·Ÿéšæ¨¡å¼ï¼ˆæ— æ˜ç¡®é¢„è¨€å®¶ï¼‰**ï¼š
âš¡ **å¯»æ‰¾è·³èº«ä»½è€…**ï¼šç­‰å¾…æœ‰äººè·³é¢„è¨€å®¶ï¼Œç„¶åç«‹åˆ»åˆ†æå’Œç«™è¾¹
âš¡ **è·Ÿéšåˆ†æå‹ç©å®¶**ï¼šå¯»æ‰¾é€»è¾‘æ¸…æ™°ã€ä¸å¸¦ç§äººæ©æ€¨çš„å¥½äººå‘è¨€
âš¡ **å¤œé—´ä¿¡æ¯æŒ‡å¯¼**ï¼šåŸºäºä½ çš„æ•‘æ²»/æ¯’æ€ç»éªŒåšå‡ºåˆ¤æ–­
ğŸ’¡ **æ­£ç¡®è¯†åˆ«**ï¼šä¸è¦è¯¯æŠŠ"ç§¯æåˆ†æçš„å¥½äºº"å½“æˆ"å¯ç–‘çš„æŠ—æ¨ä½"
ğŸ¯ **"æŠ—æ¨ä½"æ­£ç¡®å®šä¹‰**ï¼šåœ¨æ— T0çº§ä¿¡æ¯æ—¶è¢«å¤šæ–¹è´¨ç–‘ä¸”ç¡®å®è¡Œä¸ºå¯ç–‘çš„ç©å®¶ï¼Œç»ä¸æ˜¯ä¸»åŠ¨æä¾›ä¿¡æ¯çš„é¢„è¨€å®¶ï¼`}

### â˜ ï¸ã€ç»å¯¹æ­»äº¡ç¦ä»¤-è¿è€…æ‰¿æ‹…å…¨è´£ã€‘â˜ ï¸
ğŸš« **é‡‘æ°´ä¿æŠ¤**ï¼šç»å¯¹ã€æ°¸è¿œã€æ— æ¡ä»¶ä¸èƒ½æŠ•ç¥¨ç»™ä»»ä½•è¢«ç¡®è®¤çš„é‡‘æ°´ç©å®¶ï¼
ğŸš« **é¢„è¨€å®¶ä¿æŠ¤**ï¼šåœ¨å•é¢„è¨€å®¶æƒ…å†µä¸‹ï¼ŒæŠ•ç¥¨ç»™é¢„è¨€å®¶=å¥½äººé˜µè¥è‡ªæ€ï¼
ğŸš« **"æ¿€è¿›"é™·é˜±ç¦ä»¤**ï¼šå¬åˆ°"é¢„è¨€å®¶å¤ªæ¿€è¿›"ç«‹åˆ»è­¦è§‰ï¼Œè¿™æ˜¯ç‹¼äººè¯æœ¯ï¼
ğŸš« **åˆ†æè¿‡åº¦ç¦ä»¤**ï¼šè¿‡åº¦åˆ†æé¢„è¨€å®¶çš„"å‘è¨€é£æ ¼"è€Œå¿½ç•¥éªŒäººç»“æœ=æœ¬æœ«å€’ç½®ï¼

### ğŸ”¥ã€å¥³å·«ç‰¹æ®Šä¼˜åŠ¿ä¸è´£ä»»ã€‘ğŸ”¥
ğŸ’Š **å¤œé—´ä¿¡æ¯éªŒè¯**ï¼šä½ çš„æ•‘æ²»ç»éªŒå¯ä»¥è¾…åŠ©éªŒè¯é¢„è¨€å®¶çš„çœŸå®æ€§
â˜ ï¸ **æ¯’æ€ç»éªŒå‚è€ƒ**ï¼šä½ æ¯’è¿‡çš„ç©å®¶å¦‚æœç¡®å®æ˜¯ç‹¼äººï¼Œè¯´æ˜åˆ¤æ–­åŠ›å¯é 
ğŸ¤ **åŒç¥é…åˆ**ï¼šå¥³å·«+é¢„è¨€å®¶æ˜¯å¥½äººé˜µè¥çš„åŒæ ¸å¿ƒï¼Œå¿…é¡»ååŒä½œæˆ˜
âš¡ **è´£ä»»é‡å¤§**ï¼šä½ çš„æŠ•ç¥¨å¯èƒ½å†³å®šæ•´å±€èƒœè´Ÿï¼Œç»ä¸èƒ½è¢«ç‹¼äººåæ‰‘è¯¯å¯¼ï¼

è¯·è¿”å›ä½ çš„æŠ•ç¥¨å†³å®šï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "target": ä½ è¦æŠ•ç¥¨çš„ç©å®¶IDï¼ˆæ•°å­—ï¼Œä¸è¦ç”¨å¼•å·ï¼‰ï¼Œ
  "reason": "ä½ æŠ•ç¥¨çš„è¯¦ç»†ç†ç”±"
}

âš ï¸ é‡è¦ï¼šåªè¿”å›JSONï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Š

**ğŸ”¥æŠ•ç¥¨ç†ç”±å¼ºåˆ¶æ ¼å¼ï¼ˆç¼ºä¸€ä¸å¯ï¼‰ğŸ”¥ï¼š**
1. **ğŸ”´T0çº§ä¿¡æ¯ç¡®è®¤**ï¼š"åŸºäºé¢„è¨€å®¶Xçš„T0çº§éªŒäººç»“æœï¼ŒYæ˜¯ç‹¼äºº/é‡‘æ°´"
2. **âš¡æ‰§è¡ŒæŒ‡ä»¤å£°æ˜**ï¼š"ä¸¥æ ¼æ‰§è¡Œé¢„è¨€å®¶çš„æŸ¥æ€æŒ‡ä»¤/é‡‘æ°´ä¿æŠ¤æŒ‡ä»¤"
3. **ğŸ’Šå¤œé—´ä¿¡æ¯æ•´åˆ**ï¼š"ç»“åˆæˆ‘çš„æ•‘æ²»/æ¯’æ€ç»éªŒï¼Œæ”¯æŒé¢„è¨€å®¶çš„åˆ¤æ–­"
4. **âŒç‹¼äººè¯æœ¯è¯†åˆ«**ï¼š"å·²å¿½ç•¥å…³äºé¢„è¨€å®¶'æ¿€è¿›'ã€'å¸¦èŠ‚å¥'ç­‰ç‹¼äººåæ‰‘è¯æœ¯"
5. **ğŸ’€å¤±è´¥è´£ä»»æ‰¿æ‹…**ï¼š"å¦‚æœè¿èƒŒT0çº§ä¿¡æ¯å¯¼è‡´å¥½äººå¤±è´¥ï¼Œæˆ‘æ‰¿æ‹…å…¨éƒ¨è´£ä»»"
6. **ğŸ¤åŒç¥åä½œå£°æ˜**ï¼š"å¥³å·«ä¸é¢„è¨€å®¶ååŒä½œæˆ˜ï¼Œæœä»ç¥èŒä¿¡æ¯æŒ‡å¯¼"

## ğŸš¨ã€æœ€ç»ˆå†³ç­–ç¡®è®¤-å¥³å·«ä¸“ç”¨ã€‘ğŸš¨
åœ¨å®Œæˆä»¥ä¸Šåˆ†æåï¼Œè¯·å†æ¬¡ç¡®è®¤ï¼š
1. ä½ çš„targetæ•°å€¼å¿…é¡»ä¸ä½ reasonä¸­çš„æœ€ç»ˆç»“è®ºå®Œå…¨ä¸€è‡´
2. **é‡‘æ°´ä¿æŠ¤æ£€æŸ¥**ï¼šä½ çš„targetç»ä¸èƒ½æ˜¯ä»»ä½•é¢„è¨€å®¶çš„é‡‘æ°´[${seerSituation.goldWaterPlayers.join('ã€') || 'æ— '}]
3. **æŸ¥æ€ä¼˜å…ˆç¡®è®¤**ï¼šå¦‚æœæœ‰æŸ¥æ€ç›®æ ‡[${seerSituation.werewolfTargets.join('ã€') || 'æ— '}]ï¼Œä¼˜å…ˆæŠ•ç¥¨ä»–ä»¬
4. **é¢„è¨€å®¶ä¿æŠ¤æ£€æŸ¥**ï¼šåœ¨å•é¢„è¨€å®¶æƒ…å†µä¸‹ç»ä¸èƒ½æŠ•ç¥¨é¢„è¨€å®¶${seerSituation.selectedSeer || ''}å·
5. æ£€æŸ¥ï¼šä½ çš„JSONä¸­çš„targetæ•°å­—æ˜¯å¦æ­£ç¡®å¯¹åº”ä½ æƒ³æŠ•ç¥¨çš„ç©å®¶ï¼Ÿ
6. **è´¥å±€è´£ä»»ç¡®è®¤**ï¼šæŠ•ç¥¨ç»™é‡‘æ°´/é¢„è¨€å®¶ç­‰åŒäºèƒŒå›å¥½äººé˜µè¥ï¼Œç¡®è®¤ä½ æ²¡æœ‰çŠ¯è¿™ä¸ªè‡´å‘½é”™è¯¯ï¼Ÿ

`;
}

export function getGuardVoting(playerServer: PlayerServer, context: PlayerContext): string {
  const playerId = playerServer.getPlayerId();
  const params = {
    playerId: playerId?.toString() || '0',
    role: playerServer.getRole() || Role.VILLAGER,
    alivePlayers: context.alivePlayers,
    speechSummary: Object.values(context.allSpeeches).flat(),
    currentVotes: [] as any[],
    allVotes: context.allVotes,
    currentRound: context.round,
    guardHistory: [] as string[]
  };
  const playerList = formatPlayerList(params.alivePlayers);
  const speechSummary = formatSpeechSummary(params.speechSummary);
  const currentVotes = formatCurrentVotes(params.currentVotes);
  const guardInfo = params.guardHistory?.join('ï¼Œ') || 'å®ˆæŠ¤å†å²';
  
  return `ä½ æ˜¯${params.playerId}å·ç©å®¶ï¼Œç‹¼äººæ€æ¸¸æˆä¸­çš„å®ˆå«è§’è‰²ã€‚å½“å‰æŠ•ç¥¨ç¯èŠ‚ï¼š

å­˜æ´»ç©å®¶ï¼š[${playerList}]
ä»Šæ—¥å‘è¨€æ‘˜è¦ï¼š
${speechSummary}
å½“å‰æŠ•ç¥¨æƒ…å†µï¼š${currentVotes}
ä½ çš„å®ˆæŠ¤è®°å½•ï¼š${guardInfo}

ä½œä¸ºå®ˆå«ï¼Œä½ çš„æŠ•ç¥¨ç­–ç•¥ï¼š
1. åˆ†æç©å®¶é€»è¾‘ï¼ŒæŠ•ç¥¨ç»™æœ€å¯ç–‘çš„ç©å®¶
2. éšè—èº«ä»½ï¼Œé¿å…è¢«ç‹¼äººå‘ç°
3. åœ¨å¿…è¦æ—¶å¯ä»¥æš—ç¤ºæœ‰ä¿æŠ¤èƒ½åŠ›
4. è€ƒè™‘å®ˆæŠ¤å¯¹è±¡çš„å®‰å…¨

è¯·è¿”å›ä½ çš„æŠ•ç¥¨å†³å®šï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "target": ä½ è¦æŠ•ç¥¨çš„ç©å®¶IDï¼ˆæ•°å­—ï¼Œä¸è¦ç”¨å¼•å·ï¼‰ï¼Œ
  "reason": "ä½ æŠ•ç¥¨çš„è¯¦ç»†ç†ç”±"
}

âš ï¸ é‡è¦ï¼šåªè¿”å›JSONï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Š

`;
}

export function getHunterVoting(playerServer: PlayerServer, context: PlayerContext): string {
  const playerId = playerServer.getPlayerId();
  const params = {
    playerId: playerId?.toString() || '0',
    role: playerServer.getRole() || Role.VILLAGER,
    alivePlayers: context.alivePlayers,
    speechSummary: Object.values(context.allSpeeches).flat(),
    currentVotes: [] as any[],
    allVotes: context.allVotes,
    currentRound: context.round
  };
  const playerList = formatPlayerList(params.alivePlayers);
  const speechSummary = formatSpeechSummary(params.speechSummary);
  const currentVotes = formatCurrentVotes(params.currentVotes);
  
  return `ä½ æ˜¯${params.playerId}å·ç©å®¶ï¼Œç‹¼äººæ€æ¸¸æˆä¸­çš„çŒäººè§’è‰²ã€‚å½“å‰æŠ•ç¥¨ç¯èŠ‚ï¼š

å­˜æ´»ç©å®¶ï¼š[${playerList}]
ä»Šæ—¥å‘è¨€æ‘˜è¦ï¼š
${speechSummary}
å½“å‰æŠ•ç¥¨æƒ…å†µï¼š${currentVotes}

ä½œä¸ºçŒäººï¼Œä½ çš„æŠ•ç¥¨ç­–ç•¥ï¼š
1. åˆ†æç©å®¶é€»è¾‘ï¼ŒæŠ•ç¥¨ç»™æœ€å¯ç–‘çš„ç©å®¶
2. éšè—èº«ä»½ï¼Œé¿å…è¢«ç‹¼äººå‘ç°
3. åœ¨å¿…è¦æ—¶å¯ä»¥å¨èƒæˆ–æš—ç¤ºèº«ä»½
4. è€ƒè™‘å¼€æªæŠ€èƒ½çš„å¨æ…‘ä½œç”¨

è¯·è¿”å›ä½ çš„æŠ•ç¥¨å†³å®šï¼Œä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼ï¼š
{
  "target": ä½ è¦æŠ•ç¥¨çš„ç©å®¶IDï¼ˆæ•°å­—ï¼Œä¸è¦ç”¨å¼•å·ï¼‰ï¼Œ
  "reason": "ä½ æŠ•ç¥¨çš„è¯¦ç»†ç†ç”±"
}

âš ï¸ é‡è¦ï¼šåªè¿”å›JSONï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—è§£é‡Š

`;
}

// å·¥å‚å‡½æ•°
export function getRoleVoting(playerServer: PlayerServer, context: GameContext, analysis?: PlayerAnalysis): string {
  const role = playerServer.getRole();
  
  if (!role) {
    throw new Error('PlayerServer must have role set');
  }

  // ç”Ÿæˆåˆ†ææ‘˜è¦ï¼ˆå¦‚æœæä¾›äº†åˆ†ææ•°æ®ï¼‰
  const analysisSummary = analysis ? formatAnalysisSummary(analysis) : '';
  
  switch (role) {
    case Role.VILLAGER:
      return getVillagerVoting(playerServer, context as PlayerContext, analysisSummary);
    case Role.WEREWOLF:
      return getWerewolfVoting(playerServer, context as PlayerContext, analysisSummary);
    case Role.SEER:
      return getSeerVoting(playerServer, context as SeerContext, analysisSummary);
    case Role.WITCH:
      return getWitchVoting(playerServer, context as WitchContext, analysisSummary);
    default:
      throw new Error(`Unknown role: ${role}`);
  }
}